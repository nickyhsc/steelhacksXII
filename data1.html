<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NSF Table 60 — CIS & All Fields</title>
<style>
  :root{
    --b:#e5e7eb;
    --m:#6b7280;
    --fg:#111827;
    --bg:#D7E3FC;
  }
  body{
    font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:18px;
    color:var(--fg);
    line-height:1.45;
    background:var(--bg);
  }
  h1{margin:0 0 8px}
  .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .card{border:1px solid var(--b);border-radius:12px;padding:14px;margin-top:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .grid{display:grid;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  input[type=file]{padding:8px;border:1px solid var(--b);border-radius:10px}
  .muted{color:var(--m);font-size:.92rem;margin:.5rem 0 0}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>
<body>
<h1>NSF Table 60 — CIS Point Plot + All-Fields Boxplot</h1>
<div class="top">
  <span id="status" class="muted">Using <code>nsf23319-tab060.csv</code> for rendering.</span>
</div>

<div class="grid">
  <div class="card">
    <h2>CIS — Median Salary ± SE</h2>
    <div id="cis" style="width:100%;height:480px"></div>
    <div id="cisNote" class="muted"></div>
    <p id="cisDesc" class="muted"></p>
    <div class="muted" style="margin-top:10px;">
    </div>
  </div>
  <div class="card">
    <h2>All Fields — Boxplot by Sex</h2>
    <div id="box" style="width:100%;height:480px"></div>
    <div id="boxNote" class="muted"></div>
    <p id="boxDesc" class="muted"></p>
    <div class="muted" style="margin-top:10px;">
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
const num=x=>{const n=Number(String(x??'').replace(/[^0-9.]/g,''));return Number.isFinite(n)?n:NaN};
const isSex=s=>['male','female'].includes(norm(s));
const hasDigits=x=>/[0-9]/.test(String(x||''));
const fmt$=v=>'$'+Number(v).toLocaleString(undefined,{maximumFractionDigits:0});

function findHeaderStart(rows){
  for(let i=0;i<Math.min(150,rows.length);i++){
    const v=String(rows[i]?.[0]||'').toLowerCase();
    if(v.includes('field of study')) return i;
  }
  return 0;
}

function reconstruct(records){
  const out=[]; let acc=[], section=null;
  for(const r of records){
    const label=(r[0]||'').toString().trim(), sal=r[1], se=r[2];
    if(isSex(label)){ if(!section&&acc.length){section=acc.join(' ').trim();acc=[];}
      out.push({section,label,salary_raw:sal,se_raw:se}); continue; }
    if(hasDigits(sal)){ section=(acc.concat(label).join(' ').trim())||label||section; acc=[];
      out.push({section,label,salary_raw:sal,se_raw:se}); }
    else if(label) acc.push(label);
  }
  let last=null; for(const r of out){if(r.section) last=r.section; else r.section=last;}
  return out;
}

function pickCISSection(recs){
  const secs=[...new Set(recs.map(r=>r.section).filter(Boolean))];
  const cisLike=secs.filter(s=>{const n=norm(s);return n.includes('computer')&&n.includes('inform');});
  return cisLike.sort((a,b)=>a.length-b.length).pop()||null;
}

function renderCIS(recs){
  const sec=pickCISSection(recs);
  const rows=sec?recs.filter(r=>r.section===sec&&isSex(r.label)):[];
  const data=rows.map(r=>({sex:norm(r.label)==='male'?'Male':'Female',y:num(r.salary_raw),se:num(r.se_raw)}))
                 .filter(d=>Number.isFinite(d.y));
  if(!data.length){$('cisNote').textContent='Could not find CIS medians.';Plotly.purge('cis');$('cisDesc').textContent='';return;}
  Plotly.newPlot('cis',[{
    type:'scatter',mode:'markers',x:data.map(d=>d.sex),y:data.map(d=>d.y),
    error_y:{type:'data',array:data.map(d=>Number.isFinite(d.se)?d.se:0),visible:true},
    marker:{size:12},hovertemplate:'Sex: %{x}<br>Median: $%{y:,}<extra></extra>'
  }],{title:'CIS — Median ± SE',yaxis:{title:'Median salary (USD)',separatethousands:true},
      margin:{t:60,r:20,b:60,l:70}},{responsive:true});
  
  $('cisDesc').textContent = 'Description: This scatter shows the median salary for Computer & Information Sciences by sex. The vertical bars are the standard errors (SE) reported in Table 60. They each vary by 4000.';
}

function renderBox(recs){
  const rows=recs.map(r=>({sec:r.section||'',sex:isSex(r.label)?(norm(r.label)==='male'?'Male':'Female'):null,y:num(r.salary_raw)}))
                .filter(r=>r.sex&&Number.isFinite(r.y))
                .filter(r=>!/^ *(all|total)\b/i.test(r.sec));
  const males=rows.filter(r=>r.sex==='Male').map(r=>r.y);
  const females=rows.filter(r=>r.sex==='Female').map(r=>r.y);
  if(males.length<2||females.length<2){$('boxNote').textContent='Not enough values.';Plotly.purge('box');$('boxDesc').textContent='';return;}
  Plotly.newPlot('box',[
    {y:females,name:'Female',type:'box',boxpoints:false},
    {y:males,name:'Male',type:'box',boxpoints:false}
  ],{title:'Median Salaries by Sex — Across Fields',yaxis:{title:'Median salary (USD)',separatethousands:true},
     margin:{t:60,r:20,b:60,l:70}},{responsive:true});
  
  // Variety (spread) readout
  const allVals=males.concat(females);
  const overallSpread=Math.max(...allVals)-Math.min(...allVals);
  const maleSpread=Math.max(...males)-Math.min(...males);
  const femaleSpread=Math.max(...females)-Math.min(...females);
  $('boxDesc').textContent =
    `Description: This boxplot shows the distribution of field-level medians by sex. Variety (max − min) overall is ${fmt$(overallSpread)}. ` +
    `Female spread: ${fmt$(femaleSpread)}; Male spread: ${fmt$(maleSpread)}. The fields include science, computer and information sciences, mathematics and statistics, physical science, and more STEM fields. All the medians, variances, and differences of all these fields go into this boxplot to show the average in overall STEM not just specific computer and information science jobs. The wide spread of the boxes and whiskers shows the large variety in salaries between different fields, with some fields offering much higher or lower median salaries.`;
}

function process(csv){
  const start=findHeaderStart(csv);
  const rows=csv.slice(start+1);
  const recs=reconstruct(rows);
  renderCIS(recs); renderBox(recs);
}

// Load the CSV from the same folder
fetch('nsf23319-tab060.csv')
  .then(res => res.text())
  .then(text => {
    Papa.parse(text, {
      skipEmptyLines: true,
      complete: res => {
        try { process(res.data); $('status').textContent = ''; }
        catch (err) { console.error(err); $('status').textContent = 'Error: ' + err.message; }
      },
      error: er => { $('status').textContent = 'CSV parse error: ' + er.message; }
    });
  })
  .catch(err => { $('status').textContent = 'Error loading CSV: ' + err.message; });
</script>
</body>
</html>